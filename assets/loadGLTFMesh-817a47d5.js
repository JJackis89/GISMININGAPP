import{p as L,H as V,bY as O,bZ as v,eT as S,i6 as D,b1 as U,du as q,cq as H}from"./index-8ee34b61.js";import{j as N,n as K}from"./mat3-848c9a5e.js";import{e as _}from"./mat3f64-d34bdb1e.js";import{u as Q,a as Y,h as Z,p as k}from"./Mesh-23fd242b.js";import{p as J}from"./MeshVertexAttributes-edd30e12.js";import{l as C}from"./meshVertexSpaceUtils-738177a0.js";import{T as j,g as I,M as W,O as M,o as F,V as X,U as ee,y as te}from"./BufferView-b8fa1162.js";import{e as oe,f as re,s as ne,u as R}from"./vec3-fc54a44a.js";import{n as se,u as ie,c as A}from"./vec4-63e2976c.js";import{e as le}from"./types-d99602e0.js";import{loadGLTF as ue}from"./loader-40a3241e.js";import{n as ae,o as fe,a as ce,l as pe}from"./indexUtils-70808102.js";import{B as me}from"./vertexSpaceConversion-68edf03f.js";import{n as de}from"./resourceUtils-eec94bba.js";import{P as h}from"./enums-ff43618c.js";import"./MeshTransform-f54c0aff.js";import"./mat4f64-a3dc1405.js";import"./quat-3ef9ebee.js";import"./quatf64-216ddd5a.js";import"./vec32-37618b70.js";import"./imageUtils-1959a448.js";import"./MeshLocalVertexSpace-b4d6a09d.js";import"./earcut-5a6c70eb.js";import"./Indices-e0ee64fb.js";import"./plane-881ab901.js";import"./vectorStacks-f3f45332.js";import"./vec2f64-44b9a02c.js";import"./deduplicate-eda0850f.js";import"./projectPointToVector-030380a1.js";import"./spatialReferenceEllipsoidUtils-b06c2c3c.js";import"./computeTranslationToOriginAndRotation-e96691a8.js";import"./External-3bf08a6c.js";import"./vec2-08ad2285.js";import"./basicInterfaces-cbf2757f.js";function ye(e,t,o){const l=e.typedBuffer,u=e.typedBufferStride,r=t.typedBuffer,n=t.typedBufferStride,s=o?o.count:t.count;let i=(o?.dstIndex??0)*u,c=(o?.srcIndex??0)*n;for(let f=0;f<s;++f){for(let a=0;a<9;++a)l[i+a]=r[c+a];i+=u,c+=n}}Object.freeze(Object.defineProperty({__proto__:null,copy:ye},Symbol.toStringTag,{value:"Module"}));function ge(e,t,o){const l=e.typedBuffer,u=e.typedBufferStride,r=t.typedBuffer,n=t.typedBufferStride,s=o?o.count:t.count;let i=(o?.dstIndex??0)*u,c=(o?.srcIndex??0)*n;for(let f=0;f<s;++f){for(let a=0;a<16;++a)l[i+a]=r[c+a];i+=u,c+=n}}Object.freeze(Object.defineProperty({__proto__:null,copy:ge},Symbol.toStringTag,{value:"Module"}));function xe(e,t){P(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)}function P(e,t,o=3,l=o){const u=t.length/l;let r=0,n=0;for(let s=0;s<u;++s)e[r]=t[n],e[r+1]=t[n+1],e[r+2]=t[n+2],r+=o,n+=l}function z(e,t,o,l,u){const r=e.typedBuffer,n=e.typedBufferStride,s=u?.count??e.count;let i=(u?.dstIndex??0)*n;for(let c=0;c<s;++c)r[i]=t,r[i+1]=o,r[i+2]=l,i+=n}Object.freeze(Object.defineProperty({__proto__:null,copy:P,copyView:xe,fill:z},Symbol.toStringTag,{value:"Module"}));function Te(e,t){G(e.typedBuffer,t,e.typedBufferStride)}function G(e,t,o=4){const l=t.typedBuffer,u=t.typedBufferStride,r=t.count;let n=0,s=0;for(let i=0;i<r;++i)e[n]=l[s],e[n+1]=l[s+1],e[n+2]=l[s+2],e[n+3]=l[s+3],n+=o,s+=u}function $(e,t,o,l,u,r){const n=e.typedBuffer,s=e.typedBufferStride,i=r?.count??e.count;let c=(r?.dstIndex??0)*s;for(let f=0;f<i;++f)n[c]=t,n[c+1]=o,n[c+2]=l,n[c+3]=u,c+=s}Object.freeze(Object.defineProperty({__proto__:null,copy:G,copyView:Te,fill:$},Symbol.toStringTag,{value:"Module"}));function x(e,t){return new e(new ArrayBuffer(t*e.ElementCount*le(e.ElementType)))}async function ft(e,t,o){const l=new ae($e(o)),u=(await ue(l,t,o,!0)).model,r=u.lods.shift(),n=new Map,s=new Map;u.textures.forEach((g,b)=>n.set(b,Be(g))),u.materials.forEach((g,b)=>s.set(b,we(g,n)));const i=he(r);for(const g of i.parts)ve(i,g,s);const{position:c,normal:f,tangent:a,color:p,texCoord0:m}=i.vertexAttributes,d=C(e,o),B=e.spatialReference.isGeographic?C(e):d,w=me({vertexAttributes:{position:c.typedBuffer,normal:f?.typedBuffer,tangent:a?.typedBuffer},vertexSpace:B,spatialReference:e.spatialReference},d,{allowBufferReuse:!0,sourceUnit:o?.unitConversionDisabled?void 0:"meters"});if(!w)throw new L("load-gltf-mesh:vertex-space-projection",`Failed to load mesh from glTF because we could not convert the vertex space from ${B.type} to ${d.type}`);return{transform:null,vertexSpace:d,components:i.components,spatialReference:e.spatialReference,vertexAttributes:new J({...w,color:p?.typedBuffer,uv:m?.typedBuffer})}}function $e(e){const t=e?.resolveFile;return t?{busy:!1,request:async(o,l,u)=>{const r=t?.(o)??o;return(await V(r,{responseType:l==="image"?"image":l==="binary"||l==="image+type"?"array-buffer":"json",signal:u?.signal,timeout:0})).data}}:null}function T(e,t){if(e==null)return"-";const o=e.typedBuffer;return`${O(t,o.buffer,()=>t.size)}/${o.byteOffset}/${o.byteLength}`}function be(e){return e!=null?e.toString():"-"}function he(e){let t=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},l=new Map,u=new Map,r=[];for(const n of e.parts){const{position:s,normal:i,color:c,tangent:f,texCoord0:a}=n.attributes,p=`
      ${T(s,l)}/
      ${T(i,l)}/
      ${T(c,l)}/
      ${T(f,l)}/
      ${T(a,l)}/
      ${be(n.transform)}
    `;let m=!1;const d=O(u,p,()=>(m=!0,{start:t,length:s.count}));m&&(t+=s.count),i&&(o.normal=!0),c&&(o.color=!0),f&&(o.tangent=!0),a&&(o.texCoord0=!0),r.push({gltf:n,writeVertices:m,region:d})}return{vertexAttributes:{position:x(ee,t),normal:o.normal?x(F,t):null,tangent:o.tangent?x(j,t):null,color:o.color?x(I,t):null,texCoord0:o.texCoord0?x(te,t):null},parts:r,components:[]}}function Be(e){return new Q({data:(de(e.data),e.data),wrap:Ce(e.parameters.wrap)})}function we(e,t){const o=new v(Me(e.color,e.opacity)),l=e.emissiveFactor?new v(Re(e.emissiveFactor)):null,u=r=>r?new k({scale:r.scale?[r.scale[0],r.scale[1]]:[1,1],rotation:q(r.rotation??0),offset:r.offset?[r.offset[0],r.offset[1]]:[0,0]}):null;return new Y({color:o,colorTexture:t.get(e.colorTexture),normalTexture:t.get(e.normalTexture),emissiveColor:l,emissiveTexture:t.get(e.emissiveTexture),occlusionTexture:t.get(e.occlusionTexture),alphaMode:_e(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:t.get(e.metallicRoughnessTexture),colorTextureTransform:u(e.colorTextureTransform),normalTextureTransform:u(e.normalTextureTransform),occlusionTextureTransform:u(e.occlusionTextureTransform),emissiveTextureTransform:u(e.emissiveTextureTransform),metallicRoughnessTextureTransform:u(e.metallicRoughnessTextureTransform)})}function ve(e,t,o){t.writeVertices&&Se(e,t);const{indices:l,attributes:u,primitiveType:r,material:n}=t.gltf;let s=fe(l||u.position.count,r);const i=t.region.start;if(i){const c=new Uint32Array(s);for(let f=0;f<s.length;f++)c[f]+=i;s=c}e.components.push(new Z({name:t.gltf.name,faces:s,material:o.get(n),shading:u.normal?"source":"flat",trustSourceNormals:!0}))}function Se(e,t){const{position:o,normal:l,tangent:u,color:r,texCoord0:n}=e.vertexAttributes,s=t.region.start,{attributes:i,transform:c}=t.gltf,f=i.position.count;if(oe(o.slice(s,f),i.position,c),i.normal!=null&&l!=null){const a=N(_(),c),p=l.slice(s,f);re(p,i.normal,a),S(a)&&ne(p,p)}else l!=null&&z(l,0,0,1,{dstIndex:s,count:f});if(i.tangent!=null&&u!=null){const a=K(_(),c),p=u.slice(s,f);se(p,i.tangent,a),S(a)&&ie(p,p)}else u!=null&&$(u,0,0,1,1,{dstIndex:s,count:f});if(i.texCoord0!=null&&n!=null?ce(n.slice(s,f),i.texCoord0):n!=null&&pe(n,0,0,{dstIndex:s,count:f}),i.color!=null&&r!=null){const a=i.color,p=r.slice(s,f);if(a.elementCount===4)a instanceof j?A(p,a,1,255):(a instanceof I||a instanceof W)&&A(p,a,1/255,255);else{$(p,255,255,255,255);const m=M.fromTypedArray(p.typedBuffer,p.typedBufferStride);a instanceof F?R(m,a,1,255):(a instanceof M||a instanceof X)&&R(m,a,1/255,255)}}else r!=null&&$(r.slice(s,f),255,255,255,255)}function _e(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function Ce(e){return{horizontal:E(e.s),vertical:E(e.t)}}function E(e){switch(e){case h.CLAMP_TO_EDGE:return"clamp";case h.MIRRORED_REPEAT:return"mirror";case h.REPEAT:return"repeat"}}function y(e){return e**(1/H)*255}function Me(e,t){return D(y(e[0]),y(e[1]),y(e[2]),t)}function Re(e){return U(y(e[0]),y(e[1]),y(e[2]))}export{ft as loadGLTFMesh};
