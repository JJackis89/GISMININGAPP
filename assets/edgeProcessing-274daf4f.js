import{e as At}from"./deduplicate-d77038a1.js";import{O as C}from"./InterleavedLayout-9da534c5.js";import{e as u}from"./VertexAttribute-123db042.js";import{O as $}from"./enums-ff43618c.js";import{t as Et}from"./VertexElementDescriptor-2925c6af.js";import{aE as T,cc as nt,i4 as Tt,ea as Nt,cV as wt,it as Mt}from"./index-f00bd99f.js";import{p as yt,o as K,s as at,P as Q,K as vt,_ as gt,c as ct,A as mt,u as $t}from"./vec32-6757f7c3.js";function st(t,e=0){const s=t.stride;return Array.from(t.fields.keys()).map(o=>{const r=t.fields.get(o),c=r.constructor.ElementCount,h=Rt(r.constructor.ElementType),d=r.offset,g=r.optional?.glNormalized??!1;return new Et(o,c,h,d,s,g,e)})}function Rt(t){const e=Pt[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const Pt={u8:$.UNSIGNED_BYTE,u16:$.UNSIGNED_SHORT,u32:$.UNSIGNED_INT,i8:$.BYTE,i16:$.SHORT,i32:$.INT,f16:$.HALF_FLOAT,f32:$.FLOAT},Vt=C().vec3f(u.POSITION).u16(u.COMPONENTINDEX).freeze(),Dt=C().vec2u8(u.SIDENESS).freeze();st(Dt);const q=C().vec3f(u.POSITION0).vec3f(u.POSITION1).vec2i16(u.NORMALCOMPRESSED).u16(u.COMPONENTINDEX).u8(u.VARIANTOFFSET,{glNormalized:!0}).u8(u.VARIANTSTROKE).u8(u.VARIANTEXTENSION,{glNormalized:!0}).freeze(),j=C().vec3f(u.POSITION0).vec3f(u.POSITION1).vec2i16(u.NORMALCOMPRESSED).vec2i16(u.NORMAL2COMPRESSED).u16(u.COMPONENTINDEX).u8(u.VARIANTOFFSET,{glNormalized:!0}).u8(u.VARIANTSTROKE).u8(u.VARIANTEXTENSION,{glNormalized:!0}).freeze();u.POSITION0,u.POSITION1,u.COMPONENTINDEX,u.VARIANTOFFSET,u.VARIANTSTROKE,u.VARIANTEXTENSION,u.NORMALCOMPRESSED,u.NORMAL2COMPRESSED,u.SIDENESS;class xt{constructor(){this.position0=T(),this.position1=T(),this.faceNormal0=T(),this.faceNormal1=T(),this.componentIndex=0,this.cosAngle=0}}const k=-1;function Lt(t,e,s){const o=t.vertices.position,r=t.vertices.componentIndex,c=O.position0,h=O.position1,d=O.faceNormal0,g=O.faceNormal1,{edges:a,normals:p}=Bt(t),m=a.length/4,A=e.allocate(m);let V=0;const B=m,w=s?.allocate(B);let z=0,n=0,i=0;U.length=0;for(let N=0;N<m;++N){const y=4*N;o.getVec(a.data[y],c),o.getVec(a.data[y+1],h);const x=U.pushNew();x.index=4*N,x.length=yt(c,h)}U.sort((N,y)=>y.length-N.length);const f=new Array,l=new Array;U.forAll(({length:N,index:y})=>{const x=a.data[y],St=a.data[y+1],ot=a.data[y+2],rt=a.data[y+3],it=rt===k;if(o.getVec(x,c),o.getVec(St,h),it){const E=3*ot;K(d,p.data[E],p.data[E+1],p.data[E+2]),at(g,d),O.componentIndex=r.get(x),O.cosAngle=Q(d,g)}else{let E=3*ot;if(K(d,p.data[E],p.data[E+1],p.data[E+2]),E=3*rt,K(g,p.data[E],p.data[E+1],p.data[E+2]),O.componentIndex=r.get(x),O.cosAngle=Q(d,g),Ft(O,_t))return;O.cosAngle<-.9999&&at(g,d)}n+=N,i++,it||bt(O,Wt)?(e.write(A,V++,O),f.push(N)):Ct(O,It)&&(w&&s&&s.write(w,z++,O),l.push(N))});const S=new Float32Array(f.reverse()),M=new Float32Array(l.reverse()),v=w&&s?{instancesData:w.slice(0,z),lodInfo:{lengths:M}}:void 0;return{regular:{instancesData:A.slice(0,V),lodInfo:{lengths:S}},silhouette:v,averageEdgeLength:n/i}}function bt(t,e){return t.cosAngle<e}function Ft(t,e){return t.cosAngle>e}function Ct(t,e){const s=Tt(t.cosAngle);return vt(ut,t.position1,t.position0),s*(Q(gt(Ut,t.faceNormal0,t.faceNormal1),ut)>0?-1:1)>e}function Bt(t){const e=t.faces.length/3,s=t.faces,o=t.neighbors,r=t.vertices.position;I.length=Y.length=0;for(let c=0;c<e;c++){const h=3*c,d=o[h],g=o[h+1],a=o[h+2],p=s[h],m=s[h+1],A=s[h+2];r.getVec(p,D),r.getVec(m,_),r.getVec(A,X),ct(_,_,D),ct(X,X,D),gt(D,_,X),mt(D,D),Y.pushArray(D),(d===k||p<m)&&(I.push(p),I.push(m),I.push(c),I.push(d)),(g===k||m<A)&&(I.push(m),I.push(A),I.push(c),I.push(g)),(a===k||A<p)&&(I.push(A),I.push(p),I.push(c),I.push(a))}return{edges:I,normals:Y}}class zt{constructor(){this.index=0,this.length=0}}const U=new nt({allocator:t=>t||new zt,deallocator:null}),I=new nt({deallocator:null}),Y=new nt({deallocator:null}),O=new xt,Ut=T(),ut=T(),D=T(),_=T(),X=T(),It=Nt(4),_t=Math.cos(It),Xt=Nt(35),Wt=Math.cos(Xt);function lt(t,e,s){const o=e/3,r=new Uint32Array(s+1),c=new Uint32Array(s+1),h=(n,i)=>{n<i?r[n+1]++:c[i+1]++};for(let n=0;n<o;n++){const i=t[3*n],f=t[3*n+1],l=t[3*n+2];h(i,f),h(f,l),h(l,i)}let d=0,g=0;for(let n=0;n<s;n++){const i=r[n+1],f=c[n+1];r[n+1]=d,c[n+1]=g,d+=i,g+=f}const a=new Uint32Array(6*o),p=r[s],m=(n,i,f)=>{if(n<i){const l=r[n+1]++;a[2*l]=i,a[2*l+1]=f}else{const l=c[i+1]++;a[2*p+2*l]=n,a[2*p+2*l+1]=f}};for(let n=0;n<o;n++){const i=t[3*n],f=t[3*n+1],l=t[3*n+2];m(i,f,n),m(f,l,n),m(l,i,n)}const A=(n,i)=>{const f=2*n,l=i-n;for(let S=1;S<l;S++){const M=a[f+2*S],v=a[f+2*S+1];let N=S-1;for(;N>=0&&a[f+2*N]>M;N--)a[f+2*N+2]=a[f+2*N],a[f+2*N+3]=a[f+2*N+1];a[f+2*N+2]=M,a[f+2*N+3]=v}};for(let n=0;n<s;n++)A(r[n],r[n+1]),A(p+c[n],p+c[n+1]);const V=new Int32Array(3*o),B=(n,i)=>n===t[3*i]?0:n===t[3*i+1]?1:n===t[3*i+2]?2:-1,w=(n,i)=>{const f=B(n,i);V[3*i+f]=-1},z=(n,i,f,l)=>{const S=B(n,i);V[3*i+S]=l;const M=B(f,l);V[3*l+M]=i};for(let n=0;n<s;n++){let i=r[n];const f=r[n+1];let l=c[n];const S=c[n+1];for(;i<f&&l<S;){const M=a[2*i],v=a[2*p+2*l];M===v?(z(n,a[2*i+1],v,a[2*p+2*l+1]),i++,l++):M<v?(w(n,a[2*i+1]),i++):(w(v,a[2*p+2*l+1]),l++)}for(;i<f;)w(n,a[2*i+1]),i++;for(;l<S;)w(a[2*p+2*l],a[2*p+2*l+1]),l++}return V}function Z(t,e,s,o,r,c=2){const h=1/(Math.abs(s)+Math.abs(o)+Math.abs(r)),d=s*h,g=o*h,a=r<=0?(d>=0?1:-1)*(1-Math.abs(g)):d,p=r<=0?(g>=0?1:-1)*(1-Math.abs(d)):g,m=e*c;t[m]=ft(a),t[m+1]=ft(p)}function ft(t){return wt(Math.round(32767*t),-32767,32767)}const J=.7;let Ot=class{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?Ht:kt}write(e,s,o){W.seed=this._edgeHashFunction(o);const r=W.getIntRange(0,255),c=W.getIntRange(0,this.settings.variants-1),h=W.getFloat(),d=255*(.5*Gt(-(1-Math.min(h/J,1))+Math.max(0,h-J)/(1-J),1.2)+.5);e.position0.setVec(s,o.position0),e.position1.setVec(s,o.position1),e.componentIndex.set(s,o.componentIndex),e.variantOffset.set(s,r),e.variantStroke.set(s,c),e.variantExtension.set(s,d)}};const R=new Float32Array(6),P=new Uint32Array(R.buffer),F=new Uint32Array(1);function kt(t){return R[0]=t.position0[0],R[1]=t.position0[1],R[2]=t.position0[2],R[3]=t.position1[0],R[4]=t.position1[1],R[5]=t.position1[2],F[0]=31*(31*(31*(31*(31*(166811+P[0])+P[1])+P[2])+P[3])+P[4])+P[5],F[0]}function Ht(t){const e=R;e[0]=L(t.position0[0]),e[1]=L(t.position0[1]),e[2]=L(t.position0[2]),e[3]=L(t.position1[0]),e[4]=L(t.position1[1]),e[5]=L(t.position1[2]),F[0]=5381;for(let s=0;s<P.length;s++)F[0]=31*F[0]+P[s];return F[0]}const pt=1e4;function L(t){return Math.round(t*pt)/pt}function Gt(t,e){return Math.abs(t)**e*Math.sign(t)}const H=class H{constructor(){this._commonWriter=new Ot}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return q.createBuffer(e)}write(e,s,o){this._commonWriter.write(e,s,o),$t(b,o.faceNormal0,o.faceNormal1),mt(b,b);const{typedBuffer:r,typedBufferStride:c}=e.normalCompressed;Z(r,s,b[0],b[1],b[2],c)}};H.Layout=q,H.glLayout=st(q,1);let tt=H;const G=class G{constructor(){this._commonWriter=new Ot}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return j.createBuffer(e)}write(e,s,o){this._commonWriter.write(e,s,o);{const{typedBuffer:r,typedBufferStride:c}=e.normalCompressed;Z(r,s,o.faceNormal0[0],o.faceNormal0[1],o.faceNormal0[2],c)}{const{typedBuffer:r,typedBufferStride:c}=e.normal2Compressed;Z(r,s,o.faceNormal1[0],o.faceNormal1[1],o.faceNormal1[2],c)}}};G.Layout=j,G.glLayout=st(j,1);let et=G;const b=T(),W=new Mt;function se(t){const e=Kt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return ht.updateSettings(t.writerSettings),dt.updateSettings(t.writerSettings),Lt(e,ht,dt)}function Kt(t,e,s,o){if(e){const h=lt(s,o,t.count);return new qt(s,o,h,t)}const r=At(t.buffer,t.stride/4,{originalIndices:s}),c=lt(r.indices,o,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:c,vertices:Vt.createView(r.buffer)}}class qt{constructor(e,s,o,r){this.faces=e,this.facesLength=s,this.neighbors=o,this.vertices=r}}const ht=new tt,dt=new et,oe=C().vec3f(u.POSITION0).vec3f(u.POSITION1),re=C().vec3f(u.POSITION0).vec3f(u.POSITION1).u16(u.COMPONENTINDEX);export{Vt as E,oe as d,se as f,re as g,Lt as p,Kt as u};
