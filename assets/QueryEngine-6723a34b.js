import{p as b,cy as Ge,bT as Fe,bU as Se,bM as ee,bN as ot,cJ as J,as as Q,bS as ke,cH as pe,_ as k,jI as wt,iP as Qe,jJ as At,jK as bt,aD as he,bQ as vt,hW as ue,jL as Nt,jM as Pt,b2 as Pe,cP as Oe,jN as Ot,jO as Ct,cC as $t,ce as se,g3 as ut,bq as de,bs as Dt,r as ge,m as Ue,a as Vt,cr as Lt,jP as _e,cc as ye,ac as Mt,g4 as Gt,bn as we,ej as D,am as kt,jQ as Qt,cs as Ut,jR as Bt,cO as zt,cx as qt,gV as jt,c6 as $,T as Zt,jS as Ht,gG as Yt,c7 as Wt,gI as Jt,ec as Te,cd as Xt,jT as Kt,b9 as Be,cQ as es,ca as ts,cf as ss}from"./index-f00bd99f.js";import{d as is,g as Ae,G as rs,E as be,D as as,Q as ns,$ as ls,X as ze,u as os}from"./featureConversionUtils-f7ab006d.js";import{WhereClauseCache as us}from"./WhereClauseCache-89a3b7dc.js";import{e as ne}from"./OptimizedFeature-a0a9dac6.js";import{j as ie,b as cs,n as hs,a as ds,m as ms,h as z,s as fs,x as Ce,S as q,w as ps,c as qe,d as gs}from"./FixedIntervalBinParameters-c92437fc.js";import{t as _s}from"./QueryEngineCapabilities-4b2bc619.js";import{s as je}from"./quantizationUtils-4020db87.js";import{I as ys}from"./utils-9fa0ff83.js";import{m as Ie,B as Ts,d as Is,f as Ze,p as He,C as Es,k as Rs,$ as xs,E as Fs,P as Ss,U as ws,g as As,v as bs,L as vs,G as Ye}from"./utils-7142f869.js";import{r as me}from"./signal-f297c7bf.js";const ct=new us(50,500),re="unsupported-query",ht=" as ",dt=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeBigInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"]),mt=new Set(["esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"]),Ns=new Set(["esriFieldTypeString","esriFieldTypeGUID","esriFieldTypeGlobalID",...dt,...mt]);function $e(n,e,t={}){const i=Z(e,n);if(!i){const s=ct.getError(e,n);throw new b(re,"invalid SQL expression",{expression:e,error:s})}const r=t.expressionName||"expression";if(t.validateStandardized&&!i.isStandardized)throw new b(re,`${r} is not standard`,{expression:e});if(t.validateAggregate&&!i.isAggregate)throw new b(re,`${r} does not contain a valid aggregate function`,{expression:e});return i.fieldNames}function Ps(n,e,t,i){if(!t)return!0;const r="where clause";return U(n,e,$e(n,t,{validateStandardized:!0,expressionName:r}),{expressionName:r,query:i}),!0}function Os(n,e,t,i,r){if(!t)return!0;const s="having clause",a=$e(n,t,{validateAggregate:!0,expressionName:s});if(U(n,e,a,{expressionName:s,query:r}),!Z(t,n)?.getExpressions().every(u=>{const{aggregateType:c,field:h}=u,d=n.get(h)?.name;return i.some(m=>{const{onStatisticField:p,statisticType:f}=m;return n.get(p)?.name===d&&f.toLowerCase().trim()===c})}))throw new b(re,"expressions in having clause should also exist in outStatistics",{having:t});return!0}function Z(n,e){return n?ct.get(n,e):null}function ft(n){return/\((.*?)\)/.test(n)?n:n.split(ht)[0]}function Cs(n){return n.split(ht)[1]}function U(n,e,t,i={}){const r=new Map;if($s(r,n,e,i.allowedFieldTypes??Ns,t),r.size){const s=i.expressionName??"expression";throw new b(re,`${s} contains invalid or missing fields`,{errors:Array.from(r.values()),query:i.query})}}function $s(n,e,t,i,r){const s=r.includes("*")?[...t,...r.filter(a=>a!=="*")]:r;for(const a of s)if(e.get(a))We(n,e,t,i,a);else try{const l=$e(e,ft(a),{validateStandardized:!0});for(const o of l)We(n,e,t,i,o)}catch(l){n.set(a,{type:"expression-error",expression:a,error:l})}}function We(n,e,t,i,r){const s=e.get(r);s?t.has(s.name)?i!=="all"&&i?.has(s.type)===!1&&n.set(r,{type:"invalid-type",fieldName:s.name,fieldType:Ge.fromJSON(s.type),allowedFieldTypes:Array.from(i,a=>Ge.fromJSON(a))}):n.set(r,{type:"missing-field",fieldName:s.name}):n.set(r,{type:"invalid-field",fieldName:r})}const Je=new ne,Ds=new ne,ve=new ne,Ee={esriGeometryPoint:be,esriGeometryPolyline:as,esriGeometryPolygon:ns,esriGeometryMultipoint:ls};function Re(n,e,t,i=n.hasZ,r=n.hasM){if(e==null)return null;const s=n.hasZ&&i,a=n.hasM&&r;if(t){const l=Ae(ve,e,n.hasZ,n.hasM,"esriGeometryPoint",t,i,r);return be(l,s,a)}return be(e,s,a)}function L(n,e,t,i,r,s,a=e,l=t){const o=e&&a,u=t&&l,c=i!=null?"coords"in i?i:i.geometry:null;if(c==null)return null;if(r){let h=is(Ds,c,e,t,n,r,a,l);return s&&(h=Ae(ve,h,o,u,n,s)),Ee[n]?.(h,o,u)??null}if(s){const h=Ae(ve,c,e,t,n,s,a,l);return Ee[n]?.(h,o,u)??null}return rs(Je,c,e,t,a,l),Ee[n]?.(Je,o,u)??null}function ae(n){return n&&pt in n?JSON.parse(JSON.stringify(n,Vs)):n}const pt="_geVersion",Vs=(n,e)=>n===pt?void 0:e,Ls=5;let Ms=class{constructor(){this._storage=new Map,this._purgeInterval=Ls,this._sweep=()=>{if(this._timer=void 0,!this._storage)return;const e=1e3*this._purgeInterval,t=performance.now()-e;for(const[i,r]of this._storage){if(!(r.time<t))return void(this._storage.size>0&&(this._timer=setTimeout(this._sweep,e)));this._storage.delete(i)}}}destroy(){this._storage?.clear(),this._storage=null,clearTimeout(this._timer)}put(e,t){this._storage?.set(e,new ks(t)),this._scheduleSweep()}get(e){const t=this._storage?.get(e);if(t)return this._storage?.delete(e),t.time=performance.now(),this._storage?.set(e,t),t.items}clear(){this._storage?.clear()}_scheduleSweep(){this._storage&&(this._timer??(this._timer=setTimeout(this._sweep,1e3*this._purgeInterval)))}get test(){}},Gs=0,ks=class{constructor(e){this.items=e,this.time=performance.now(),this.id=Gs++}},K=class{constructor(e,t,i){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=e.returnDistinctValues??!1,this.fieldsIndex=i,this.featureAdapter=t;const r=e.outFields;if(r&&!r.includes("*")){this.outFields=r;let s=0;for(const a of r){const l=ft(a),o=this.fieldsIndex.get(l),u=o?null:Z(l,i),c=o?o.name:Cs(a)||"FIELD_EXP_"+s++;this._fieldDataCache.set(a,{alias:c,clause:u})}}}countDistinctValues(e){return this.returnDistinctValues?(e.forEach(t=>this.getAttributes(t)),this._returnDistinctMap.size):e.length}getAttributes(e){const t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}getFieldValue(e,t,i){const r=i?i.name:t;let s=null;return this._fieldDataCache.has(r)?s=this._fieldDataCache.get(r)?.clause:i||(s=Z(t,this.fieldsIndex),this._fieldDataCache.set(r,{alias:r,clause:s})),i?this.featureAdapter.getAttribute(e,r):s?.calculateValue(e,this.featureAdapter)}getDataValues(e,t,i=!0){const r=t.normalizationType,s=t.normalizationTotal,a=this.fieldsIndex.get(t.field),l=Fe(a)||Se(a),o=ee(a);return e.map(u=>{let c=t.field&&this.getFieldValue(u,t.field,this.fieldsIndex.get(t.field));if(t.field2?(c=`${Ie(c)}${t.fieldDelimiter}${Ie(this.getFieldValue(u,t.field2,this.fieldsIndex.get(t.field2)))}`,t.field3&&(c=`${c}${t.fieldDelimiter}${Ie(this.getFieldValue(u,t.field3,this.fieldsIndex.get(t.field3)))}`)):typeof c=="string"&&i&&(l?c=c?new Date(c).getTime():null:o&&(c=c?ys(c):null)),r&&Number.isFinite(c)){const h=r==="field"&&t.normalizationField?this.getFieldValue(u,t.normalizationField,this.fieldsIndex.get(t.normalizationField)):null;c=Ts(c,r,h,s)}return c})}async getExpressionValues(e,t,i,r,s){const{arcadeUtils:a}=await ot(),l=a.hasGeometryOperations(t);l&&await a.enableGeometryOperations();const o=a.createFunction(t),u=a.getViewInfo(i),c={fields:this.fieldsIndex.fields};return e.map(h=>{const d={attributes:this.featureAdapter.getAttributes(h),layer:c,geometry:l?{...L(r.geometryType,r.hasZ,r.hasM,this.featureAdapter.getGeometry(h)),spatialReference:i?.spatialReference}:null},m=a.createExecContext(d,u,s);return a.executeFunction(o,m)})}validateItem(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:Z(t,this.fieldsIndex)}),this._fieldDataCache.get(t)?.clause?.testFeature(e,this.featureAdapter)??!1}validateItems(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:Z(t,this.fieldsIndex)}),this._fieldDataCache.get(t)?.clause?.testSet(e,this.featureAdapter)??!1}_processAttributesForOutFields(e){const t=this.outFields;if(!t?.length)return this.featureAdapter.getAttributes(e);const i={};for(const r of t){const{alias:s,clause:a}=this._fieldDataCache.get(r);i[s]=a?a.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,s)}return i}_processAttributesForDistinctValues(e){if(e==null||!this.returnDistinctValues)return e;const t=this.outFields,i=[];if(t)for(const a of t){const{alias:l}=this._fieldDataCache.get(a);i.push(e[l])}else for(const a in e)i.push(e[a]);const r=`${(t||["*"]).join(",")}=${i.join(",")}`;let s=this._returnDistinctMap.get(r)||0;return this._returnDistinctMap.set(r,++s),s>1?null:e}};function Xe(n,e,t){return{objectId:n,target:e,distance:t,type:"vertex"}}function Qs(n,e,t,i,r,s=!1){return{objectId:n,target:e,distance:t,type:"edge",start:i,end:r,draped:s}}const W="bin";let P=class{constructor(e,t,i){this.items=e,this.query=t,this.geometryType=i.geometryType,this.hasM=i.hasM,this.hasZ=i.hasZ,this.fieldsIndex=i.fieldsIndex,this.objectIdField=i.objectIdField,this.spatialReference=i.spatialReference,this.featureAdapter=i.featureAdapter}get size(){return this.items.length}createQueryResponseForCount(){const e=new K(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return e.countDistinctValues(this.items);const{groupByFieldsForStatistics:t,having:i,outStatistics:r}=this.query;if(!t?.length)return 1;const a=new Map,l=new Map,o=new Set;for(const u of r){const{statisticType:c}=u,h=c!=="exceedslimit"?u.onStatisticField:void 0;if(!l.has(h)){const m=[];for(const p of t){const f=this._getAttributeValues(e,p,this.items,a);m.push(f)}l.set(h,this._calculateUniqueValues(m,this.items,e.returnDistinctValues))}const d=l.get(h);for(const m in d){const{data:p,items:f}=d[m],E=p.join(",");i&&!e.validateItems(f,i)||o.add(E)}}return o.size}async createQueryResponse(){let e;if(this.query.outStatistics?e=this.query.outStatistics.some(t=>t.statisticType==="exceedslimit")?this._createExceedsLimitQueryResponse():await this._createStatisticsQueryResponse(this.query,this.items):e=this._createFeatureQueryResponse(this.query),this.query.returnQueryGeometry){const t=this.query.geometry;J(this.query.outSR)&&!Q(t.spatialReference,this.query.outSR)?e.queryGeometry=ae({spatialReference:this.query.outSR,...ie(t,t.spatialReference,this.query.outSR)}):e.queryGeometry=ae({spatialReference:this.query.outSR,...t})}return e}createSnappingResponse(e,t,i){const r=this.featureAdapter,s=Ke(this.hasZ,this.hasM),{point:a,mode:l}=e,o=typeof e.distance=="number"?e.distance:e.distance.x,u=typeof e.distance=="number"?e.distance:e.distance.y,c={candidates:[]},h=this.geometryType==="esriGeometryPolygon",d=this.geometryType==="esriGeometryPolyline"||this.geometryType==="esriGeometryPoint",m=this._getPointCreator(l,t,this.spatialReference,i),p=new et(null,0),f=new et(null,0),E={x:0,y:0,z:0};for(const R of this.items){const x=r.getGeometry(R);if(x==null)continue;const{coords:F}=x,_=x.isPoint?Bs:x.lengths;if(p.coords=F,f.coords=F,e.returnEdge){let y=0;for(let T=0;T<_.length;T++){const g=_[T],S=y;for(let w=0;w<g;w++,y+=s){if(!h&&w===g-1)continue;const A=p;A.coordsIndex=y;const v=f;v.coordsIndex=w===g-1?S:y+s;const M=E;if(!Us(E,a,A,v))continue;const N=(a.x-M.x)/o,V=(a.y-M.y)/u,B=N*N+V*V;B<=1&&c.candidates.push(Qs(r.getObjectId(R),m(M),Math.sqrt(B),m(A),m(v)))}}}if(e.vertexMode==="all"){let y=0;for(let T=0;T<_.length;T++){const g=_[T],S=y,w=f;w.coordsIndex=S;for(let A=0;A<g;A++,y+=s){const v=p;if(v.coordsIndex=y,h&&A===g-1&&v.x===w.x&&v.y===w.y)continue;const M=(a.x-v.x)/o,N=(a.y-v.y)/u,V=M*M+N*N;V<=1&&c.candidates.push(Xe(r.getObjectId(R),m(v),Math.sqrt(V)))}}}else if(d&&e.vertexMode==="ends"){let y=0;const T=[];for(let g=0;g<_.length;g++){T.push(y);const S=_[g];y+=S*s,!h&&S>1&&T.push(y-s)}for(const g of T){const S=p;S.coordsIndex=g;const w=(a.x-S.x)/o,A=(a.y-S.y)/u,v=w*w+A*A;v<=1&&c.candidates.push(Xe(r.getObjectId(R),m(S),Math.sqrt(v)))}}}return c.candidates.sort((R,x)=>R.distance-x.distance),c}_getPointCreator(e,t,i,r){const s=r==null||Q(i,r)?o=>o:o=>ie(o,i,r),{hasZ:a}=this,l=0;return e==="3d"?a&&t?({x:o,y:u,z:c})=>s({x:o,y:u,z:c}):({x:o,y:u})=>s({x:o,y:u,z:l}):({x:o,y:u})=>s({x:o,y:u})}async createSummaryStatisticsResponse(e){const{field:t,valueExpression:i,normalizationField:r,normalizationType:s,normalizationTotal:a,minValue:l,maxValue:o,scale:u,timeZone:c,outStatisticTypes:h}=e,d=this.fieldsIndex.get(t),m=ke(d)||Fe(d)||Se(d),p=await this._getDataValues({field:t,valueExpression:i,normalizationField:r,normalizationType:s,normalizationTotal:a,scale:u,timeZone:c},this.items),f=Is({normalizationType:s,normalizationField:r,minValue:l,maxValue:o}),E={value:.5,fieldType:d?.type},R=pe(d)?Ze({values:p,supportsNullCount:f,percentileParams:E,outStatisticTypes:h}):He({values:p,minValue:l,maxValue:o,useSampleStdDev:!s,supportsNullCount:f,percentileParams:E,outStatisticTypes:h});return Es(R,h,m)}async createUniqueValuesResponse(e){const{field:t,valueExpression:i,domains:r,returnAllCodedValues:s,scale:a,timeZone:l}=e,o=await this._getDataValues({field:t,field2:e.field2,field3:e.field3,fieldDelimiter:e.fieldDelimiter,valueExpression:i,scale:a,timeZone:l},this.items,!1),u=Rs(o);return xs(u,r,s,e.fieldDelimiter)}async createClassBreaksResponse(e){const{field:t,valueExpression:i,normalizationField:r,normalizationType:s,normalizationTotal:a,classificationMethod:l,standardDeviationInterval:o,minValue:u,maxValue:c,numClasses:h,scale:d,timeZone:m}=e,p=await this._getDataValues({field:t,valueExpression:i,normalizationField:r,normalizationType:s,normalizationTotal:a,scale:d,timeZone:m},this.items),f=Fs(p,{field:t,normalizationField:r,normalizationType:s,normalizationTotal:a,classificationMethod:l,standardDeviationInterval:o,minValue:u,maxValue:c,numClasses:h});return Ss(f,l)}async createHistogramResponse(e){const{field:t,valueExpression:i,normalizationField:r,normalizationType:s,normalizationTotal:a,classificationMethod:l,standardDeviationInterval:o,minValue:u,maxValue:c,numBins:h,scale:d,timeZone:m}=e,p=await this._getDataValues({field:t,valueExpression:i,normalizationField:r,normalizationType:s,normalizationTotal:a,scale:d,timeZone:m},this.items);return ws(p,{field:t,normalizationField:r,normalizationType:s,normalizationTotal:a,classificationMethod:l,standardDeviationInterval:o,minValue:u,maxValue:c,numBins:h})}_sortFeatures(e,t,i){if(e.length>1&&t?.length)for(const r of t.slice().reverse()){const s=r.split(" "),a=s[0],l=this.fieldsIndex.get(a),o=!!s[1]&&s[1].toLowerCase()==="desc",u=As(l?.type,o);e.sort((c,h)=>{const d=i(c,a,l),m=i(h,a,l);return u(d,m)})}}_createFeatureQueryResponse(e){const{items:t,geometryType:i,hasM:r,hasZ:s,objectIdField:a,spatialReference:l}=this,{outFields:o,outSR:u,quantizationParameters:c,resultRecordCount:h,resultOffset:d,returnZ:m,returnM:p}=e,f=h!=null&&t.length>(d||0)+h,E=o&&(o.includes("*")?[...this.fieldsIndex.fields]:o.map(R=>this.fieldsIndex.get(R)));return{exceededTransferLimit:f,features:this._createFeatures(e,t),fields:E,geometryType:i,hasM:r&&p,hasZ:s&&m,objectIdFieldName:a,spatialReference:ae(u||l),transform:c&&je(c)||null}}_createFeatures(e,t){const i=new K(e,this.featureAdapter,this.fieldsIndex),{hasM:r,hasZ:s}=this,{orderByFields:a,quantizationParameters:l,returnGeometry:o,returnCentroid:u,maxAllowableOffset:c,resultOffset:h,resultRecordCount:d,returnZ:m=!1,returnM:p=!1}=e,f=s&&m,E=r&&p;let R=[],x=0;const F=[...t];if(this._sortFeatures(F,a,(y,T,g)=>i.getFieldValue(y,T,g)),this.geometryType&&(o||u)){const y=je(l)??void 0,T=this.geometryType==="esriGeometryPolygon"||this.geometryType==="esriGeometryPolyline";if(o&&!u)for(const g of F){const S=this.featureAdapter.getGeometry(g),w={attributes:i.getAttributes(g),geometry:L(this.geometryType,this.hasZ,this.hasM,S,c,y,f,E),metadata:this.featureAdapter.getMetadata?.(g)};T&&S&&!w.geometry&&(w.centroid=Re(this,this.featureAdapter.getCentroid(g,this),y)),R[x++]=w}else if(!o&&u)for(const g of F)R[x++]={attributes:i.getAttributes(g),centroid:Re(this,this.featureAdapter.getCentroid(g,this),y)};else for(const g of F)R[x++]={attributes:i.getAttributes(g),centroid:Re(this,this.featureAdapter.getCentroid(g,this),y),geometry:L(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(g),c,y,f,E),metadata:this.featureAdapter.getMetadata?.(g)}}else for(const y of F){const T=i.getAttributes(y);T&&(R[x++]={attributes:T})}const _=h||0;if(d!=null){const y=_+d;R=R.slice(_,Math.min(R.length,y))}return R}_createExceedsLimitQueryResponse(){let e=!1,t=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY;for(const s of this.query.outStatistics??[])if(s.statisticType==="exceedslimit"){t=s.maxPointCount!=null?s.maxPointCount:Number.POSITIVE_INFINITY,i=s.maxRecordCount!=null?s.maxRecordCount:Number.POSITIVE_INFINITY,r=s.maxVertexCount!=null?s.maxVertexCount:Number.POSITIVE_INFINITY;break}if(this.geometryType==="esriGeometryPoint")e=this.items.length>t;else if(this.items.length>i)e=!0;else{const s=Ke(this.hasZ,this.hasM),a=this.featureAdapter;e=this.items.reduce((l,o)=>{const u=a.getGeometry(o);return l+(u!=null&&u.coords.length||0)},0)/s>r}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(e)}}]}}async _createStatisticsQueryResponse(e,t,i={attributes:{}}){const r=[],s=new Map,a=new Map,l=new Map,o=new Map,u=new K(e,this.featureAdapter,this.fieldsIndex),c=e.outStatistics,{groupByFieldsForStatistics:h,having:d,orderByFields:m,resultRecordCount:p}=e,f=h?.length,E=!!f,R=E?h[0]:null,x=E&&!this.fieldsIndex.get(R);for(const _ of c??[]){const{outStatisticFieldName:y,statisticType:T}=_,g=_,S=T!=="exceedslimit"?_.onStatisticField:void 0,w=T==="percentile_disc"||T==="percentile_cont",A=T==="EnvelopeAggregate"||T==="CentroidAggregate"||T==="ConvexHullAggregate",v=E&&f===1&&(S===R||x)&&T==="count";if(E){if(!l.has(S)){const B=[];for(const fe of h){const oe=this._getAttributeValues(u,fe,t,s);B.push(oe)}l.set(S,this._calculateUniqueValues(B,t,!A&&u.returnDistinctValues))}const N=l.get(S);if(!N)continue;const V=Object.keys(N);for(const B of V){const{count:fe,data:oe,items:Ve,itemPositions:xt}=N[B],Le=oe.join(",");if(!d||u.validateItems(Ve,d)){const Y=o.get(Le)||{attributes:{}};if(A){Y.aggregateGeometries||(Y.aggregateGeometries={});const{aggregateGeometries:G,outStatisticFieldName:X}=await this._getAggregateGeometry(g,Ve);Y.aggregateGeometries[X]=G}else{let G=null;if(v)G=fe;else{const X=this._getAttributeValues(u,S,t,s),Me=xt.map(St=>X[St]);G=w&&"statisticParameters"in g?this._getPercentileValue(g,Me):this._getStatisticValue(g,Me,null,u.returnDistinctValues)}Y.attributes[y]=G}let Ft=0;h.forEach((G,X)=>Y.attributes[this.fieldsIndex.get(G)?G:"EXPR_"+ ++Ft]=oe[X]),o.set(Le,Y)}}}else if(A){i.aggregateGeometries||(i.aggregateGeometries={});const{aggregateGeometries:N,outStatisticFieldName:V}=await this._getAggregateGeometry(g,t);i.aggregateGeometries[V]=N}else{const N=this._getAttributeValues(u,S,t,s);i.attributes[y]=w&&"statisticParameters"in g?this._getPercentileValue(g,N):this._getStatisticValue(g,N,a,u.returnDistinctValues)}const M=T!=="min"&&T!=="max"||!pe(this.fieldsIndex.get(S))&&!this._isAnyDateField(S)?null:this.fieldsIndex.get(S)?.type;r.push({name:y,alias:y,type:M||"esriFieldTypeDouble"})}const F=E?Array.from(o.values()):[i];return this._sortFeatures(F,m,(_,y)=>_.attributes[y]),p&&(F.length=Math.min(p,F.length)),{fields:r,features:F}}_isAnyDateField(e){const t=this.fieldsIndex.get(e);return ke(t)||Fe(t)||Se(t)||ee(t)}async _getAggregateGeometry(e,t){const{convexHull:i,union:r}=await k(()=>import("./geometryEngineJSON-7115f56e.js"),["assets/geometryEngineJSON-7115f56e.js","assets/geometryEngineBase-7de0a3cc.js","assets/_commonjsHelpers-b09fa337.js","assets/geometryEngineJSON-ec2f929c.js","assets/json-48e3ea08.js"]),{statisticType:s,outStatisticFieldName:a}=e,{featureAdapter:l,spatialReference:o,geometryType:u,hasZ:c,hasM:h}=this,d=t.map(f=>L(u,c,h,l.getGeometry(f))),m=i(o,d,!0)[0],p={aggregateGeometries:null,outStatisticFieldName:null};if(s==="EnvelopeAggregate"){const f=m?wt(m):Qe(r(o,d));p.aggregateGeometries={...f,spatialReference:o},p.outStatisticFieldName=a||"extent"}else if(s==="CentroidAggregate"){const f=m?At(m):bt(Qe(r(o,d)));p.aggregateGeometries={x:f[0],y:f[1],spatialReference:o},p.outStatisticFieldName=a||"centroid"}else s==="ConvexHullAggregate"&&(p.aggregateGeometries=m,p.outStatisticFieldName=a||"convexHull");return p}_getStatisticValue(e,t,i,r){const{onStatisticField:s,statisticType:a}=e;let l=null;return l=i?.has(s)?i.get(s):pe(this.fieldsIndex.get(s))||this._isAnyDateField(s)?Ze({values:t,returnDistinct:r}):He({values:r?[...new Set(t)]:t,minValue:null,maxValue:null,useSampleStdDev:!0}),i&&i.set(s,l),l[a==="var"?"variance":a]}_getPercentileValue(e,t){const{onStatisticField:i,statisticParameters:r,statisticType:s}=e,{value:a,orderBy:l}=r,o=this.fieldsIndex.get(i);return bs(t,{value:a,orderBy:l,fieldType:o?.type,isDiscrete:s==="percentile_disc"})}_getAttributeValues(e,t,i,r){if(r.has(t))return r.get(t);const s=this.fieldsIndex.get(t),a=i.map(l=>e.getFieldValue(l,t,s));return r.set(t,a),a}_calculateUniqueValues(e,t,i){const r={},s=t.length;for(let a=0;a<s;a++){const l=t[a],o=[];for(const c of e)o.push(c[a]);const u=o.join(",");r[u]==null?r[u]={count:1,data:o,items:[l],itemPositions:[a]}:(i||r[u].count++,r[u].items.push(l),r[u].itemPositions.push(a))}return r}async _getDataValues(e,t,i=!0){const r=new K(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:s,scale:a,timeZone:l}=e;return s?r.getExpressionValues(t,s,{viewingMode:"map",scale:a,spatialReference:this.query.outSR||this.spatialReference},{geometryType:this.geometryType,hasZ:this.hasZ,hasM:this.hasM},l):r.getDataValues(t,he(e),i)}async _calculateHistogramBins(e,t,i){if(t.min==null&&t.max==null)return[];const r=t.intervals,s=t.min??0,a=t.max??0,l=r.map(([o,u])=>({minValue:o,maxValue:u,count:0,items:[]}));for(let o=0;o<e.length;o++){const u=e[o],c=i[o];if(u!=null&&u>=s&&u<=a){const h=vs(r,u);h>-1&&(l[h].count++,l[h].items.push(c))}}return l}async createQueryBinsResponse(e){const t=e.bin?.splitBy;if(!t)return this._createBinsResponse(e);const{value:i,outAlias:r,valueType:s}=t,a=[],l=[{name:r??i,alias:r??i,type:s??"esriFieldTypeString"},{name:W,alias:W,type:"esriFieldTypeInteger"}],o=new K(e,this.featureAdapter,this.fieldsIndex),u=new Map,c=[...this.items];this._sortFeatures(c,[i],(m,p,f)=>o.getFieldValue(m,p,f));const h=this._getAttributeValues(o,i,c,u),d=this._calculateUniqueValues([h],c,o.returnDistinctValues);for(const m in d){const{items:p}=d[m],f=await this._createBinsResponse(e,p);if(a.push(...f.features.map(E=>({...E,attributes:{...E.attributes,[r??i]:m}}))),f.fields)for(const E of f.fields)l.some(R=>R.name===E.name)||l.push(E)}return{fields:l,features:a}}async _createBinsResponse(e,t){const i=e.bin;switch(t=t??this.items,i.type){case"autoIntervalBin":return this._createAutoIntervalBinsResponse(ms.fromJSON(i),e,t);case"dateBin":return this._createDateBinsResponse(ds.fromJSON(i),e,t);case"fixedBoundariesBin":return this._createFixedBoundariesBinsResponse(hs.fromJSON(i),e,t);case"fixedIntervalBin":return this._createFixedIntervalBinsResponse(cs.fromJSON(i),e,t)}}async _createAutoIntervalBinsResponse(e,t,i){const{field:r,normalizationField:s,numBins:a,normalizationType:l,normalizationTotal:o,start:u,end:c}=e,h=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},i),d=Ye(h,{field:r,normalizationField:s,normalizationType:l,normalizationTotal:o,numBins:a,minValue:z(u,!1),maxValue:z(c,!1)}),m=await this._calculateHistogramBins(h,d,i);return this._createFeaturesFromHistogramBins(m,t)}async _createDateBinsResponse(e,t,i){const{field:r,interval:s,start:a,end:l,snapToData:o,returnFullIntervalBin:u}=e,c=s.unit,h=await this._getDataValues({field:e.field,timeZone:t.outTimeReference?.ianaTimeZone},i),d=ee(this.fieldsIndex.get(r)),m=fs.toJSON(c),p=h.filter(Boolean).sort((T,g)=>T-g),f=a!=null?z(a,d):p[0],E=l!=null?z(l,d):p[p.length-1],R={zone:t.outTimeReference?.ianaTimeZone??vt},x=ue.fromMillis(f,R),F=ue.fromMillis(E,R),_=[];if(o==="last"){let T=F;for(;T>x;){const g=T.minus({[m]:s.value});if(g<x){_.unshift([u?g.toMillis():x.toMillis(),T.toMillis()]);break}_.unshift([g.toMillis(),T.toMillis()]),T=g}}else{let T=o==="first"?x:x.startOf(m);for(;T<=F;){const g=T.plus({[m]:s.value});if(g>F){_.push([T.toMillis(),u?g.toMillis():F.toMillis()]);break}_.push([T.toMillis(),g.toMillis()]),T=g}}const y=await this._calculateHistogramBins(h,{intervals:_,min:f,max:E},i);return this._createFeaturesFromHistogramBins(y,t)}async _createFixedBoundariesBinsResponse(e,t,i){const{field:r}=e,s=await this._getDataValues({field:r,timeZone:t.outTimeReference?.ianaTimeZone},i),a=ee(this.fieldsIndex.get(r)),l=e.boundaries.map(h=>z(h,a)).sort((h,d)=>h-d),o=[];for(let h=0;h<l.length-1;h++)o.push([l[h],l[h+1]]);const u={intervals:o,min:l.at(0),max:l.at(-1)},c=await this._calculateHistogramBins(s,u,i);return this._createFeaturesFromHistogramBins(c,t)}async _createFixedIntervalBinsResponse(e,t,i){const{field:r,interval:s,start:a,end:l}=e,o=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},i),u=ee(this.fieldsIndex.get(r)),c=Ye(o,{field:r,classificationMethod:"defined-interval",definedInterval:s,minValue:z(a,u),maxValue:z(l,u)},!0),h=await this._calculateHistogramBins(o,c,i);return this._createFeaturesFromHistogramBins(h,t)}async _createFeaturesFromHistogramBins(e,t){const{upperBoundaryAlias:i,lowerBoundaryAlias:r}=t,s=r||"lowerBoundary",a=i||"upperBoundary",l=[],o=[{name:s,alias:s,type:"esriFieldTypeDouble"},{name:a,alias:a,type:"esriFieldTypeDouble"}],u=t.bin?.stackBy?.value,c=t.bin?.stackBy?.outAlias;u&&o.push({name:W,alias:W,type:"esriFieldTypeInteger"},{name:c??u,alias:c??u,type:"esriFieldTypeString"});let h=0;const d=t.bin.type==="dateBin",m=t.outTimeReference?.ianaTimeZone;for(const p of e){const{minValue:f,maxValue:E,items:R}=p,x={attributes:{}};let F;if(x.attributes[s]=d&&m&&f!=null?ue.fromMillis(f,{zone:m}).toISO():f,x.attributes[a]=d&&m&&E!=null?ue.fromMillis(E,{zone:m}).toISO():E,u?(F=await this._createStatisticsQueryResponse({...t,groupByFieldsForStatistics:[u],orderByFields:[u]},R),x.attributes[W]=++h,t.bin.jsonStyle==="flat"?l.push(...F.features.map(({attributes:{EXPR_1:_,...y},...T})=>({...T,attributes:c??_?{...y,[c??_]:_,...x.attributes}:{...y,...x.attributes}}))):(x.stackedAttributes=F.features.map(({attributes:{EXPR_1:_,...y}})=>c??_?{...y,[c??_]:_}:y),l.push(x))):(t.bin?.splitBy&&(x.attributes[W]=++h),F=await this._createStatisticsQueryResponse(t,R,x),l.push(x)),F.fields)for(const _ of F.fields)o.some(y=>y.name===_.name)||o.push(_)}return t.binOrder==="desc"&&l.reverse(),{fields:o,features:l}}};function Us(n,e,t,i){const r=i.x-t.x,s=i.y-t.y,a=e.x-t.x,l=e.y-t.y,o=r*r+s*s;if(o===0)return!1;const u=a*r+l*s,c=Math.min(1,Math.max(0,u/o));return n.x=t.x+r*c,n.y=t.y+s*c,!0}function Ke(n,e){return n?e?4:3:e?3:2}let et=class{constructor(e,t){this.coords=e,this.coordsIndex=t}get x(){return this.coords[this.coordsIndex]}get y(){return this.coords[this.coordsIndex+1]}get z(){return this.coords[this.coordsIndex+2]}};const Bs=[1];function zs(n){return n==="mesh"?Nt:Pt(n)}function gt(n,e){return n?e?4:3:e?3:2}function qs(n,e,t,i){return _t(n,e,t,i.coords[0],i.coords[1])}function js(n,e,t,i,r,s){const a=gt(r,s),{coords:l,lengths:o}=i;if(!o)return!1;for(let u=0,c=0;u<o.length;u++,c+=a)if(!_t(n,e,t,l[c],l[c+1]))return!1;return!0}function _t(n,e,t,i,r){if(!n)return!1;const s=gt(e,t),{coords:a,lengths:l}=n;let o=!1,u=0;for(const c of l)o=Zs(o,a,s,u,c,i,r),u+=c*s;return o}function Zs(n,e,t,i,r,s,a){let l=n,o=i;for(let u=i,c=i+r*t;u<c;u+=t){o=u+t,o===c&&(o=i);const h=e[u],d=e[u+1],m=e[o],p=e[o+1];(d<a&&p>=a||p<a&&d>=a)&&h+(a-d)/(p-d)*(m-h)<s&&(l=!l)}return l}const xe="unsupported-query",De={spatialRelationship:{esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},queryGeometry:{esriGeometryPoint:!0,esriGeometryMultiPatch:!1,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},layerGeometry:{esriGeometryPoint:!0,esriGeometryMultiPatch:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1}};function Hs(n){return n!=null&&De.spatialRelationship[n]===!0}function Ys(n){return n!=null&&De.queryGeometry[$t(n)]===!0}function Ws(n){return n!=null&&De.layerGeometry[n]===!0}const Js={esriSpatialRelIntersects:()=>k(()=>import("./intersectsOperator-2310fee7.js"),["assets/intersectsOperator-2310fee7.js","assets/OperatorIntersects-e04f66fb.js","assets/ProjectionTransformation-a3dffea2.js","assets/Envelope2D-4833fda6.js","assets/Point2D-e62ad2de.js","assets/Transformation2D-ab2ac5ee.js","assets/SimpleGeometryCursor-e3941f41.js","assets/index-f00bd99f.js","assets/index-a5714ce2.css","assets/OperatorDefinitions-181ceaf8.js","assets/jsonConverter-77f04cbc.js"]),esriSpatialRelContains:()=>k(()=>import("./containsOperator-7beb084d.js"),["assets/containsOperator-7beb084d.js","assets/ProjectionTransformation-a3dffea2.js","assets/Envelope2D-4833fda6.js","assets/Point2D-e62ad2de.js","assets/Transformation2D-ab2ac5ee.js","assets/SimpleGeometryCursor-e3941f41.js","assets/index-f00bd99f.js","assets/index-a5714ce2.css","assets/OperatorDefinitions-181ceaf8.js","assets/jsonConverter-77f04cbc.js"]),esriSpatialRelCrosses:()=>k(()=>import("./crossesOperator-2f1c6b70.js"),["assets/crossesOperator-2f1c6b70.js","assets/OperatorCrosses-a9d3e0ab.js","assets/ProjectionTransformation-a3dffea2.js","assets/Envelope2D-4833fda6.js","assets/Point2D-e62ad2de.js","assets/Transformation2D-ab2ac5ee.js","assets/SimpleGeometryCursor-e3941f41.js","assets/index-f00bd99f.js","assets/index-a5714ce2.css","assets/OperatorDefinitions-181ceaf8.js","assets/jsonConverter-77f04cbc.js"]),esriSpatialRelDisjoint:()=>k(()=>import("./disjointOperator-4d201c08.js"),["assets/disjointOperator-4d201c08.js","assets/ProjectionTransformation-a3dffea2.js","assets/Envelope2D-4833fda6.js","assets/Point2D-e62ad2de.js","assets/Transformation2D-ab2ac5ee.js","assets/SimpleGeometryCursor-e3941f41.js","assets/index-f00bd99f.js","assets/index-a5714ce2.css","assets/OperatorDefinitions-181ceaf8.js","assets/jsonConverter-77f04cbc.js"]),esriSpatialRelEnvelopeIntersects:null,esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:()=>k(()=>import("./overlapsOperator-68c03f2f.js"),["assets/overlapsOperator-68c03f2f.js","assets/OperatorOverlaps-c74fcf72.js","assets/ProjectionTransformation-a3dffea2.js","assets/Envelope2D-4833fda6.js","assets/Point2D-e62ad2de.js","assets/Transformation2D-ab2ac5ee.js","assets/SimpleGeometryCursor-e3941f41.js","assets/index-f00bd99f.js","assets/index-a5714ce2.css","assets/OperatorDefinitions-181ceaf8.js","assets/jsonConverter-77f04cbc.js"]),esriSpatialRelTouches:()=>k(()=>import("./touchesOperator-fade8df9.js"),["assets/touchesOperator-fade8df9.js","assets/OperatorTouches-6b19c4a2.js","assets/ProjectionTransformation-a3dffea2.js","assets/Envelope2D-4833fda6.js","assets/Point2D-e62ad2de.js","assets/Transformation2D-ab2ac5ee.js","assets/SimpleGeometryCursor-e3941f41.js","assets/index-f00bd99f.js","assets/index-a5714ce2.css","assets/OperatorDefinitions-181ceaf8.js","assets/jsonConverter-77f04cbc.js"]),esriSpatialRelWithin:()=>k(()=>import("./withinOperator-3ea66b8e.js"),["assets/withinOperator-3ea66b8e.js","assets/OperatorWithin-62cfdbab.js","assets/ProjectionTransformation-a3dffea2.js","assets/Envelope2D-4833fda6.js","assets/Point2D-e62ad2de.js","assets/Transformation2D-ab2ac5ee.js","assets/SimpleGeometryCursor-e3941f41.js","assets/index-f00bd99f.js","assets/index-a5714ce2.css","assets/OperatorDefinitions-181ceaf8.js","assets/jsonConverter-77f04cbc.js"]),esriSpatialRelRelation:null};function Xs(n){const e=Js[n];if(e==null)throw new Error(`Cannot load unsupported spatial operator: ${n}`);return e()}async function ce(n,e,t,i,r){if(Pe(e)){if(t==="esriGeometryPoint"&&(n==="esriSpatialRelIntersects"||n==="esriSpatialRelContains")){const a=ze(new ne,e,!1,!1);return l=>qs(a,!1,!1,l)}if(t==="esriGeometryMultipoint"){const a=ze(new ne,e,!1,!1);if(n==="esriSpatialRelContains")return l=>js(a,!1,!1,l,i,r)}}if(Oe(e)){if(t==="esriGeometryPoint"&&(n==="esriSpatialRelIntersects"||n==="esriSpatialRelContains"))return a=>Ot(e,L(t,i,r,a));if(t==="esriGeometryMultipoint"&&n==="esriSpatialRelContains")return a=>Ct(e,L(t,i,r,a));if(n==="esriSpatialRelIntersects"){const a=zs(t);return l=>a(e,L(t,i,r,l))}}n==="esriSpatialRelEnvelopeIntersects"&&(n="esriSpatialRelIntersects");const s=await Xs(n);return a=>s.execute(e,L(t,i,r,a))}async function yt(n,e,t){const{spatialRel:i,geometry:r}=n;if(r){if(!Hs(i))throw new b(xe,"Unsupported query spatial relationship",{query:n});if(J(r.spatialReference)&&J(t)){if(!Ys(r))throw new b(xe,"Unsupported query geometry type",{query:n});if(!Ws(e))throw new b(xe,"Unsupported layer geometry type",{query:n});if(n.outSR)return Ce(n.geometry?.spatialReference,n.outSR)}}}function Tt(n){if(Oe(n))return!0;if(Pe(n)){for(const e of n.rings)if(e.length!==5||e[0][0]!==e[1][0]||e[0][0]!==e[4][0]||e[2][0]!==e[3][0]||e[0][1]!==e[3][1]||e[0][1]!==e[4][1]||e[1][1]!==e[2][1])return!1;return!0}return!1}const H="unsupported-query";async function Ks(n,e){const t=n.bin;if(!t.onField&&!t.onExpression?.value||t.type==="autoIntervalBin"&&t.parameters.numberOfBins==null||t.type==="dateBin"&&(t.parameters.number==null||t.parameters.unit==null)||t.type==="fixedBoundariesBin"&&t.parameters.boundaries==null||t.type==="fixedIntervalBin"&&t.parameters.interval==null)throw new b(H,"Unsupported query options",{query:n});return It(n,e)}async function It(n,{fieldsIndex:e,geometryType:t,spatialReference:i,availableFields:r}){if(n.geometryPrecision!=null||n.multipatchOption&&n.multipatchOption!=="xyFootprint"||n.pixelSize||n.relationParam||n.text)throw new b(H,"Unsupported query options",{query:n});return Et(e,r,n),ti(e,r,n),Promise.all([yt(n,t,i),Ce(i,n.outSR)]).then(()=>n)}function Et(n,e,t){const{returnDistinctValues:i,outStatistics:r}=t,s=r?r.map(a=>a.outStatisticFieldName&&a.outStatisticFieldName.toLowerCase()).filter(Boolean):[];if("orderByFields"in t&&t.orderByFields&&t.orderByFields.length>0){const a=" asc",l=" desc",o=t.orderByFields.map(u=>{const c=u.toLowerCase();return c.includes(a)?c.split(a)[0]:c.includes(l)?c.split(l)[0]:u}).filter(u=>!s.includes(u));U(n,e,o,{expressionName:"orderByFields",query:t})}if("outFields"in t){if(t.outFields?.length)U(n,e,t.outFields,{expressionName:"outFields",query:t,allowedFieldTypes:"all"});else if(i)throw new b(H,"outFields should be specified for returnDistinctValues",{query:t})}Ps(n,e,t.where,t)}const ei=new Set([...dt,...mt]);function ti(n,e,t){const{outStatistics:i,groupByFieldsForStatistics:r,having:s}=t,a=r?.length,l=i?.length;if(s){if(!a||!l)throw new b(H,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:t});Os(n,e,s,i,t)}if(l){if(!ri(i))return;const o=i.map(u=>u.onStatisticField).filter(Boolean);U(n,e,o,{expressionName:"onStatisticFields",query:t}),a&&U(n,e,r,{expressionName:"groupByFieldsForStatistics",query:t});for(const u of i){const{onStatisticField:c,statisticType:h}=u;if((h==="percentile_disc"||h==="percentile_cont")&&"statisticParameters"in u){const{statisticParameters:d}=u;if(!d)throw new b(H,"statisticParameters should be set for percentile type",{definition:u,query:t})}else n.get(c)&&h!=="count"&&h!=="min"&&h!=="max"&&U(n,e,[c],{expressionName:`outStatistics with '${h}' statistic type`,allowedFieldTypes:ei,query:t})}}}async function si(n,e,{fieldsIndex:t,geometryType:i,spatialReference:r,availableFields:s}){if(n.geometryPrecision!=null||n.multipatchOption||n.pixelSize||n.relationParam||n.text||n.outStatistics||n.groupByFieldsForStatistics||n.having||n.orderByFields)throw new b(H,"Unsupported query options",{query:n});return Et(t,s,n),Promise.all([ii(t,s,e,n),yt(n,i,r),Ce(r,n.outSR)]).then(()=>n)}async function ii(n,e,t,i){let r=[];if(t.valueExpression){const{arcadeUtils:s}=await ot();r=s.extractFieldNames(t.valueExpression)}if(t.field&&r.push(t.field),t.field2&&r.push(t.field2),t.field3&&r.push(t.field3),t.normalizationField&&r.push(t.normalizationField),!r.length&&!t.valueExpression)throw new b(H,"field or valueExpression is required",{params:t});U(n,e,r,{expressionName:"statistics",query:i})}function ri(n){return n!=null&&n.every(e=>e.statisticType!=="exceedslimit")}async function ai(n,e){if(!n)return null;const t=e.featureAdapter,{startTimeField:i,endTimeField:r}=n;let s=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;if(i&&r)await e.forEach(l=>{const o=t.getAttribute(se(l),i),u=t.getAttribute(se(l),r);o==null||isNaN(o)||(s=Math.min(s,o)),u==null||isNaN(u)||(a=Math.max(a,u))});else{const l=i||r;await e.forEach(o=>{const u=t.getAttribute(se(o),l);u==null||isNaN(u)||(s=Math.min(s,u),a=Math.max(a,u))})}return{start:s,end:a}}function ni(n,e,t){if(!e||!n)return null;const{startTimeField:i,endTimeField:r}=n;if(!i&&!r)return null;const{start:s,end:a}=e;if(s===null&&a===null)return null;if(s===void 0&&a===void 0)return ui();const l=t.getAttributeAsTimestamp?.bind(t)??t.getAttribute.bind(t);return i&&r?li(l,i,r,s,a):oi(l,i||r,s,a)}function li(n,e,t,i,r){return i!=null&&r!=null?s=>{const a=n(s,e),l=n(s,t);return(a==null||a<=r)&&(l==null||l>=i)}:i!=null?s=>{const a=n(s,t);return a==null||a>=i}:r!=null?s=>{const a=n(s,e);return a==null||a<=r}:void 0}function oi(n,e,t,i){return t!=null&&i!=null&&t===i?r=>n(r,e)===t:t!=null&&i!=null?r=>{const s=n(r,e);return s!=null&&s>=t&&s<=i}:t!=null?r=>{const s=n(r,e);return s!=null&&s>=t}:i!=null?r=>{const s=n(r,e);return s!=null&&s<=i}:void 0}function ui(){return()=>!1}const Rt=Symbol("Yield");class ci{constructor(){this._tasks=new Array,this._numPendingTasks=me(0),this._running=me(!1)}get length(){return this._tasks.length}get updating(){return this._numPendingTasks.value>0}get running(){return this._running.value}_updateRunning(){this._running.value=this._tasks.length>0}destroy(){this.cancelAll()}runTask(e){if(this.length===0)return Rt;for(;!e.done&&this._process(e);)e.madeProgress()}push(e,t,i){return new Promise((r,s)=>{this._tasks.push(new tt(r,s,e,t,i)),++this._numPendingTasks.value,this._updateRunning()}).finally(()=>--this._numPendingTasks.value)}unshift(e,t,i){return new Promise((r,s)=>{this._tasks.unshift(new tt(r,s,e,t,i)),++this._numPendingTasks.value,this._updateRunning()}).finally(()=>--this._numPendingTasks.value)}_process(e){if(this._tasks.length===0)return!1;const t=this._tasks.shift();this._updateRunning();try{const i=ut(t.signal);if(i&&!t.abortCallback)t.reject(de());else{const r=i?t.abortCallback?.(de()):t.callback(e);Dt(r)?r.then(t.resolve,t.reject):t.resolve(r)}}catch(i){t.reject(i)}return!0}cancelAll(){const e=de();for(const t of this._tasks)if(t.abortCallback){const i=t.abortCallback(e);t.resolve(i)}else t.reject(e);this._tasks.length=0,this._updateRunning()}}class tt{constructor(e,t,i,r=void 0,s=void 0){this.resolve=e,this.reject=t,this.callback=i,this.signal=r,this.abortCallback=s}}let te=class extends Lt{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};ge([Ue()],te.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),ge([Ue()],te.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),te=ge([Vt("esri.views.support.debugFlags")],te);const hi=new te;var O;(function(n){n[n.ANIMATING=0]="ANIMATING",n[n.INTERACTING=1]="INTERACTING",n[n.IDLE=2]="IDLE"})(O||(O={}));var I;(function(n){n.RESOURCE_CONTROLLER_IMMEDIATE="immediate",n.RESOURCE_CONTROLLER="schedule",n.SLIDE="slide",n.STREAM_DATA_LOADER="stream loader",n.ELEVATION_QUERY="elevation query",n.TERRAIN_SURFACE="terrain",n.SURFACE_GEOMETRY_UPDATES="surface geometry updates",n.LOD_RENDERER="LoD renderer",n.GRAPHICS_CORE="Graphics3D",n.I3S_CONTROLLER="I3S",n.POINT_CLOUD_LAYER="point cloud",n.FEATURE_TILE_FETCHER="feature fetcher",n.OVERLAY="overlay",n.OVERLAY_RENDERER="overlay renderer",n.STAGE="stage",n.GRAPHICS_DECONFLICTOR="graphics deconflictor",n.FILTER_VISIBILITY="Graphics3D filter visibility",n.SCALE_VISIBILITY="Graphics3D scale visibility",n.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",n.POINT_OF_INTEREST_FREQUENT="POI frequent",n.POINT_OF_INTEREST_INFREQUENT="POI infrequent",n.LABELER="labeler",n.FEATURE_QUERY_ENGINE="feature query",n.FEATURE_TILE_TREE="feature tile tree",n.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",n.ELEVATION_ALIGNMENT="elevation alignment",n.ELEVATION_ALIGNMENT_SCENE="elevation alignment scene",n.TEXT_TEXTURE_ATLAS="text texture atlas",n.TEXTURE_UNLOAD="texture unload",n.LINE_OF_SIGHT_TOOL="line of sight tool",n.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",n.ELEVATION_PROFILE="elevation profile",n.SNAPPING="snapping",n.SHADOW_ACCUMULATOR="shadow accumulator",n.CLOUDS_GENERATOR="clouds generator",n.MAPVIEW_FETCH_QUEUE="mapview fetch queue",n.MAPVIEW_LAYERVIEW_UPDATE="mapview layerview update",n.MAPVIEW_VECTOR_TILE_PARSING_QUEUE="mapview vector tile parsing queue",n[n.NONE=0]="NONE",n[n.TEST_PRIO=1]="TEST_PRIO"})(I||(I={}));const C=0,st=new Map([[I.RESOURCE_CONTROLLER_IMMEDIATE,C],[I.RESOURCE_CONTROLLER,4],[I.SLIDE,C],[I.STREAM_DATA_LOADER,C],[I.ELEVATION_QUERY,C],[I.TERRAIN_SURFACE,1],[I.SURFACE_GEOMETRY_UPDATES,1],[I.LOD_RENDERER,2],[I.GRAPHICS_CORE,2],[I.I3S_CONTROLLER,2],[I.POINT_CLOUD_LAYER,2],[I.FEATURE_TILE_FETCHER,2],[I.CLOUDS_GENERATOR,2],[I.OVERLAY,4],[I.OVERLAY_RENDERER,4],[I.STAGE,4],[I.GRAPHICS_DECONFLICTOR,4],[I.FILTER_VISIBILITY,4],[I.SCALE_VISIBILITY,4],[I.FRUSTUM_VISIBILITY,4],[I.POINT_OF_INTEREST_FREQUENT,6],[I.POINT_OF_INTEREST_INFREQUENT,30],[I.LABELER,8],[I.FEATURE_QUERY_ENGINE,8],[I.FEATURE_TILE_TREE,16],[I.FEATURE_TILE_TREE_ACTIVE,C],[I.ELEVATION_ALIGNMENT,12],[I.ELEVATION_ALIGNMENT_SCENE,14],[I.TEXT_TEXTURE_ATLAS,12],[I.TEXTURE_UNLOAD,12],[I.LINE_OF_SIGHT_TOOL,16],[I.LINE_OF_SIGHT_TOOL_INTERACTIVE,C],[I.SNAPPING,C],[I.SHADOW_ACCUMULATOR,30],[I.MAPVIEW_FETCH_QUEUE,C],[I.MAPVIEW_LAYERVIEW_UPDATE,2],[I.MAPVIEW_VECTOR_TILE_PARSING_QUEUE,C]]);function it(n){return st.has(n)?st.get(n):typeof n=="number"?n:1}const di=D(6.5),rt=D(1),mi=D(30),fi=D(1e3/30),pi=D(100),at=.9;var Ne,j;(function(n){class e{get updating(){return this._updating.value}_updatingChanged(){this._updating.value=this._tasks.some(s=>s.needsUpdate)}constructor(){this._updating=me(!0),this._microTaskQueued=!1,this._frameNumber=0,this.performanceInfo={total:new _e("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=new i,this._state=O.INTERACTING,this._tasks=new ye,this._runQueue=new ye,this._load=0,this._idleStateCallbacks=new ye,this._idleUpdatesStartFired=!1,this._forceTask=!1,this._debug=!1,this._debugHandle=Mt(()=>hi.SCHEDULER_LOG_SLOW_TASKS,s=>this._debug=s,Gt);for(const s of Object.keys(I))this.performanceInfo.tasks.set(I[s],new _e(I[s]))}destroy(){this._tasks.toArray().forEach(s=>s.remove()),this._tasks.clear(),we(this._debugHandle),this._microTaskQueued=!1,this._updatingChanged()}taskRunningChanged(s){this._updatingChanged(),s&&this._budget.remaining>0&&!this._microTaskQueued&&(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.remaining>0&&this._schedule()&&this._runFrame())}))}registerTask(s,a){const l=new t(this,s,a);return this._tasks.push(l),this._updatingChanged(),this.performanceInfo.tasks.has(s)||this.performanceInfo.tasks.set(s,new _e(s)),l}registerIdleStateCallbacks(s,a){const l={idleBegin:s,idleEnd:a};this._idleStateCallbacks.push(l),this.state===O.IDLE&&this._idleUpdatesStartFired&&l.idleBegin();const o=this;return{remove:()=>this._removeIdleStateCallbacks(l),set idleBegin(u){o._idleUpdatesStartFired&&(l.idleEnd(),o._state===O.IDLE&&u()),l.idleBegin=u},set idleEnd(u){l.idleEnd=u}}}get load(){return this._load}set state(s){this._state!==s&&(this._state=s,this.state!==O.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(a=>a.idleEnd())))}get state(){return this._state}frame(s){this._startFrameTaskTimes();const a=this._updateBudget(s);if(a){const l=this._budget.now();this._runFrame(),this._recordFrameTaskTimes(this._budget.now()-l)}else this._recordFrameTaskTimes(0);return a}_updateBudget(s){this._test&&(this._test.usedBudget=0),++this._frameNumber;let a=di,l=s.frameDuration,o=rt;switch(this.state){case O.IDLE:a=D(0),l=D(Math.max(pi,s.frameDuration)),o=mi;break;case O.INTERACTING:l=D(Math.max(fi,s.frameDuration));case O.ANIMATING:}return l=D(l-s.elapsedFrameTime-a),this.state!==O.IDLE&&l<rt&&!this._forceTask?(this._forceTask=!0,!1):(l=D(Math.max(l,o)),this._budget.reset(l),this._updateLoad(),this._schedule())}_runFrame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case O.IDLE:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(s=>s.idleBegin())),this._runIdle();break;case O.INTERACTING:this._runInteracting();break;default:this._runAnimating()}this._test&&(this._test.usedBudget=this._budget.elapsed)}stopFrame(){this._budget.reset(D(0)),this._budget.madeProgress()}_removeIdleStateCallbacks(s){this._idleUpdatesStartFired&&s.idleEnd(),this._idleStateCallbacks.removeUnordered(s)}removeTask(s){this._tasks.removeUnordered(s),this._runQueue.removeUnordered(s),this._updatingChanged()}_updateTask(s){this._tasks.forAll(a=>{a.name===s&&a.setPriority(s)})}_getState(s){if(this._runQueue.some(l=>l.name===s))return j.SCHEDULED;let a=j.IDLE;return this._tasks.forAll(l=>{l.name===s&&l.needsUpdate&&(l.schedulePriority<=1?a=j.READY:a!==j.READY&&(a=j.WAITING))}),a}_getRuntime(s){let a=0;return this._tasks.forAll(l=>{l.name===s&&(a+=l.runtime)}),a}_resetRuntimes(){this._tasks.forAll(s=>s.runtime=0)}_getRunning(){const s=new Map;if(this._tasks.forAll(l=>{l.needsUpdate&&s.set(l.name,(s.get(l.name)||0)+1)}),s.size===0)return null;let a="";return s.forEach((l,o)=>{a+=l>1?` ${l}x ${o}`:` ${o}`}),a}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const s=this._tasks.reduce((a,l)=>l.needsUpdate?++a:a,0);this._load=this._load*at+s*(1-at)}_schedule(){for(this._runQueue.filterInPlace(s=>!!s.needsUpdate||(s.schedulePriority=s.basePriority,!1)),this._tasks.forAll(s=>{s.basePriority===C&&s.needsUpdate&&!this._runQueue.includes(s)&&s.blockFrame!==this._frameNumber&&this._runQueue.unshift(s)});this._runQueue.length===0;){let s=!1,a=0;if(this._tasks.forAll(l=>{l.needsUpdate&&l.schedulePriority!==0&&l.basePriority!==C&&l.blockFrame!==this._frameNumber&&(s=!0,a=Math.max(a,l.basePriority),l.schedulePriority===1?(l.schedulePriority=0,this._runQueue.push(l)):--l.schedulePriority)}),!s)return this._updatingChanged(),!1}return this._updatingChanged(),!0}_run(){do for(;this._runQueue.length>0;){const s=this._budget.now(),a=this._runQueue.pop();this._budget.resetProgress();try{a.task.runTask(this._budget)===Rt&&(a.blockFrame=this._frameNumber)}catch(o){kt.getLogger("esri.views.support.Scheduler").error(`Exception in task "${a.name}"`,o),a.blockFrame=this._frameNumber}!this._budget.hasProgressed&&a.blockFrame!==this._frameNumber&&a.needsUpdate&&(a.name,I.I3S_CONTROLLER,a.blockFrame=this._frameNumber),a.schedulePriority=a.basePriority;const l=this._budget.now()-s;if(a.runtime+=l,this._frameTaskTimes.set(a.priority,this._frameTaskTimes.get(a.priority)+l),this._budget.remaining<=0)return void this._updatingChanged()}while(this._schedule());this._updatingChanged()}_startFrameTaskTimes(){for(const s of Object.keys(I))this._frameTaskTimes.set(I[s],0)}_recordFrameTaskTimes(s){this._frameTaskTimes.forEach((a,l)=>this.performanceInfo.tasks.get(l).push(a)),this.performanceInfo.total.push(s)}get test(){return this._test}}n.Scheduler=e;class t{get task(){return this._task.value}get updating(){return this._queue.running}constructor(s,a,l){this._scheduler=s,this.name=a,this.blockFrame=0,this.runtime=0,this._queue=new ci,this._handles=new Qt,this._basePriority=it(a),this.schedulePriority=this._basePriority,this._task=me(l??this._queue),this._handles.add(Ut(()=>this.task.running,o=>s.taskRunningChanged(o)))}remove(){this.processQueue(le),this._scheduler.removeTask(this),this.schedule=nt.schedule,this.reschedule=nt.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(s){if(this.name===s)return;this.name=s;const a=it(s);this._basePriority!==C&&this.schedulePriority===0||(this.schedulePriority=a),this._basePriority=a}get priority(){return this.name}set priority(s){this.setPriority(s)}get needsUpdate(){return this.updating||this.task.running}schedule(s,a,l){return this._queue.push(s,a,l)}reschedule(s,a,l){return this._queue.unshift(s,a,l)}processQueue(s){return this._queue.runTask(s)}}let i=class{constructor(){this._begin=performance?.now()??0,this._budget=0,this._done=!1,this._progressed=!1,this._enabled=!0}run(s){return!this.done&&(s()===!0&&this.madeProgress(),!0)}get done(){return this._done}get budget(){return this._budget}madeProgress(){return this._progressed=!0,this._done=this.elapsed>=this._budget&&this._enabled,this._done}get enabled(){return this._enabled}set enabled(s){this._enabled=s}reset(s){this._begin=this.now(),this._budget=s,this.resetProgress()}get remaining(){return Math.max(this._budget-this.elapsed,0)}now(){return performance.now()}get elapsed(){return this.now()-this._begin}resetProgress(){this._progressed=!1,this._done=!1}get hasProgressed(){return this._progressed}};n.Budget=i})(Ne||(Ne={})),function(n){n.SCHEDULED="s",n.READY="r",n.WAITING="w",n.IDLE="i"}(j||(j={}));const le=new Ne.Budget;le.enabled=!1;class gi{remove(){}processQueue(){}schedule(e,t,i){try{if(ut(t)){const r=de();return i?Promise.resolve(i(r)):Promise.reject(r)}return Bt(e(le))}catch(r){return Promise.reject(r)}}reschedule(e,t,i){return this.schedule(e,t,i)}}const nt=new gi,_i="unsupported-query";class $i{constructor(e){this._changeHandle=null,this.capabilities={query:_s},this.geometryType=e.geometryType,this.hasM=!!e.hasM,this.hasZ=!!e.hasZ,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._cache=e.cache??new Ms,this.timeInfo=e.timeInfo,this.featureIdInfo=e.featureIdInfo,e.featureIdInfo.type==="object-id"&&(this.objectIdField=e.featureIdInfo.fieldName),this._changeHandle=this.featureStore.events.on("changed",()=>this._clearCache()),this.fieldsIndex=zt(e.fieldsIndex)?e.fieldsIndex:qt.fromJSON(e.fieldsIndex),!e.availableFields||e.availableFields.length===1&&e.availableFields[0]==="*"?this.availableFields=new Set(this.fieldsIndex.fields.map(t=>t.name)):this.availableFields=new Set(e.availableFields.map(t=>this.fieldsIndex.get(t)?.name).filter(t=>t!=null)),e.scheduler&&e.priority&&(this._frameTask=e.scheduler.registerTask(e.priority))}destroy(){this._changeHandle=we(this._changeHandle),this._frameTask=we(this._frameTask),this._clearCache(),jt(this._cache)}get featureAdapter(){return this.featureStore.featureAdapter}_clearCache(){this._cache.clear(),this._allFeaturesPromise=null,this._timeExtentPromise=null,this._fullExtentPromise=null}async executeQuery(e,t){const i=$(t);try{return await(await this._executeQuery(e,{},i)).createQueryResponse()}catch(r){if(r!==q)throw r;return new P([],e,this).createQueryResponse()}}async executeQueryForCount(e={},t){const i=$(t);try{return(await this._executeQuery(e,{returnGeometry:!1,returnCentroid:!1,outSR:null},i)).createQueryResponseForCount()}catch(r){if(r!==q)throw r;return 0}}async executeQueryForExtent(e,t){const i=$(t),r=e.outSR;try{const s=await this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},i),a=s.size;return a?{count:a,extent:await this._getBounds(s.items,s.spatialReference,r||this.spatialReference)}:{count:0,extent:null}}catch(s){if(s===q)return{count:0,extent:null};throw s}}async executeQueryForIds(e,t){return this.executeQueryForIdSet(e,t).then(i=>Array.from(i))}async executeQueryForIdSet(e,t){const i=$(t);try{const r=await this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},i),s=r.items,a=new Set;return await this.reschedule(()=>{for(const l of s)a.add(r.featureAdapter.getObjectId(l))},i),a}catch(r){if(r===q)return new Set;throw r}}async executeQueryForLatestObservations(e,t){const i=$(t);if(!this.timeInfo?.trackIdField)throw new b(_i,"Missing timeInfo or timeInfo.trackIdField",{query:e,timeInfo:this.timeInfo});try{const r=await this._executeQuery(e,{},i);return await this.reschedule(()=>this._filterLatest(r),i),await r.createQueryResponse()}catch(r){if(r!==q)throw r;return new P([],e,this).createQueryResponse()}}async executeAttributeBinsQuery(e,t){const i=$(t);let r;e=he(e);try{e=await this.schedule(()=>ps(e,this.definitionExpression,this.spatialReference),i),e=await this.reschedule(()=>Ks(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),i);const s=await this.reschedule(()=>this._executeSceneFilterQuery(e,i),i);r=await this.reschedule(()=>this._executeGeometryQuery(e,s,i),i),await this.reschedule(()=>this._executeAggregateIdsQuery(r),i),await this.reschedule(()=>this.executeObjectIdsQuery(r),i),await this.reschedule(()=>this.executeTimeQuery(r),i),await this.reschedule(()=>this.executeAttributesQuery(r),i)}catch(s){if(s!==q)throw s;r=new P([],e,this)}return r.createQueryBinsResponse(e)}async executeQueryForSummaryStatistics(e={},t,i){const r=$(i),{field:s,normalizationField:a,valueExpression:l}=t;return(await this._executeQueryForStatistics(e,{field:s,normalizationField:a,valueExpression:l},r)).createSummaryStatisticsResponse(t)}async executeQueryForUniqueValues(e={},t,i){const r=$(i),{field:s,field2:a,field3:l,valueExpression:o}=t;return(await this._executeQueryForStatistics(e,{field:s,field2:a,field3:l,valueExpression:o},r)).createUniqueValuesResponse(t)}async executeQueryForClassBreaks(e={},t,i){const r=$(i),{field:s,normalizationField:a,valueExpression:l}=t;return(await this._executeQueryForStatistics(e,{field:s,normalizationField:a,valueExpression:l},r)).createClassBreaksResponse(t)}async executeQueryForHistogram(e={},t,i){const r=$(i),{field:s,normalizationField:a,valueExpression:l}=t;return(await this._executeQueryForStatistics(e,{field:s,normalizationField:a,valueExpression:l},r)).createHistogramResponse(t)}async fetchRecomputedExtents(e){const t=$(e);this._timeExtentPromise||(this._timeExtentPromise=ai(this.timeInfo,this.featureStore));const[i,r]=await Promise.all([this._getFullExtent(),this._timeExtentPromise]);return Zt(t),{fullExtent:i,timeExtent:r}}async _getBounds(e,t,i){const r=Ht(Wt(),Yt);await this.featureStore.forEachBounds(e,l=>Jt(r,l));const s={xmin:r[0],ymin:r[1],xmax:r[3],ymax:r[4],spatialReference:ae(this.spatialReference)};this.hasZ&&isFinite(r[2])&&isFinite(r[5])&&(s.zmin=r[2],s.zmax=r[5],s.hasZ=!0);const a=ie(s,t,i);if(a.spatialReference=ae(i),a.xmax-a.xmin===0){const l=Te(a.spatialReference);a.xmin-=l,a.xmax+=l}if(a.ymax-a.ymin===0){const l=Te(a.spatialReference);a.ymin-=l,a.ymax+=l}if(this.hasZ&&a.zmin!=null&&a.zmax!=null&&a.zmax-a.zmin===0){const l=Te(a.spatialReference);a.zmin-=l,a.zmax+=l}return a}_getFullExtent(){return this._fullExtentPromise||(this._fullExtentPromise="getFullExtent"in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getAllFeatures().then(e=>this._getBounds(e,this.spatialReference,this.spatialReference))),this._fullExtentPromise}async schedule(e,t){return this._frameTask?.schedule(e,t)??e(le)}async reschedule(e,t){return this._frameTask?.reschedule(e,t)??e(le)}async _getAllFeaturesQueryEngineResult(e){return new P(await this._getAllFeatures(),e,this)}async _getAllFeatures(){if(this._allFeaturesPromise==null){const i=[];this._allFeaturesPromise=(async()=>await this.featureStore.forEach(r=>i.push(r)))().then(()=>se(i))}const e=this._allFeaturesPromise,t=await e;return e===this._allFeaturesPromise?t.slice():this._getAllFeatures()}async _executeQuery(e,t,i){e=he(e),e=await this.schedule(()=>qe(e,this.definitionExpression,this.spatialReference),i),e=await this.reschedule(()=>It(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),i),e={...e,...t};const r=await this.reschedule(()=>this._executeSceneFilterQuery(e,i),i),s=await this.reschedule(()=>this._executeGeometryQuery(e,r,i),i);return await this.reschedule(()=>this._executeAggregateIdsQuery(s),i),await this.reschedule(()=>this.executeObjectIdsQuery(s),i),await this.reschedule(()=>this.executeTimeQuery(s),i),await this.reschedule(()=>this.executeAttributesQuery(s),i),s}async _executeSceneFilterQuery(e,t){if(e.sceneFilter==null)return null;const{outSR:i,returnGeometry:r,returnCentroid:s}=e,a=this.featureStore.featureSpatialReference,l=e.sceneFilter.geometry,o=a==null||Q(a,l.spatialReference)?l:ie(l,a);if(!o)return null;const u=r||s,c=J(i)&&!Q(this.spatialReference,i)&&u?async f=>this._project(f,i):f=>f,h=this.featureAdapter,d=await this.reschedule(()=>this.searchFeatures(lt(o)),t);if(e.sceneFilter.spatialRelationship==="disjoint"){if(!d.length)return null;const f=new Set;for(const x of d)f.add(h.getObjectId(x));const E=await this.reschedule(()=>this._getAllFeatures(),t),R=await this.reschedule(async()=>{const x=await ce("esriSpatialRelDisjoint",o,this.geometryType,this.hasZ,this.hasM),F=y=>!f.has(h.getObjectId(y))||x(h.getGeometry(y)),_=await this.runSpatialFilter(E,F,t);return new P(_,e,this)},t);return c(R)}if(!d.length)return new P([],e,this);if(this._canExecuteSinglePass(o,e))return c(new P(d,e,this));const m=await ce("esriSpatialRelContains",o,this.geometryType,this.hasZ,this.hasM),p=await this.runSpatialFilter(d,f=>m(h.getGeometry(f)),t);return c(new P(p,e,this))}async _executeGeometryQuery(e,t,i){if(t!=null&&t.items.length===0)return t;const{geometry:r,outSR:s,returnGeometry:a,returnCentroid:l}=e,o=t?null:this._getCacheKey(e),u=o?this._cache.get(o):null;if(u)return new P(u,e,this);const c=J(s)&&!Q(this.spatialReference,s),h=a||l,d=async _=>(c&&h&&await this._project(_,s),o&&this._cache.put(o,_.items),_),m=this.featureStore.featureSpatialReference,p=!r||m==null||Q(m,r.spatialReference)?r:ie(r,m);if(!p)return d(t??await this._getAllFeaturesQueryEngineResult(e));const f=this.featureAdapter;let E=await this.reschedule(()=>this.searchFeatures(lt(r)),i);const R=e.spatialRel??"esriSpatialRelIntersects";if(R==="esriSpatialRelDisjoint"){if(!E.length)return d(t??await this._getAllFeaturesQueryEngineResult(e));const _=new Set;for(const g of E)_.add(f.getObjectId(g));const y=t!=null?t.items:await this.reschedule(()=>this._getAllFeatures(),i),T=await this.reschedule(async()=>{const g=await ce(R,p,this.geometryType,this.hasZ,this.hasM),S=A=>!_.has(f.getObjectId(A))||g(f.getGeometry(A)),w=await this.runSpatialFilter(y,S,i);return new P(w,e,this)},i);return d(T)}if(t!=null){const _=new ss;E=E.filter(y=>Xt(t.items,y,t.items.length,_)>=0)}if(!E.length){const _=new P([],e,this);return o&&this._cache.put(o,_.items),_}if(this._canExecuteSinglePass(p,e))return d(new P(E,e,this));const x=await ce(R,p,this.geometryType,this.hasZ,this.hasM),F=await this.runSpatialFilter(E,_=>x(f.getGeometry(_)),i);return d(new P(F,e,this))}_executeAggregateIdsQuery(e){if(e.items.length===0||!e.query.aggregateIds?.length||this.aggregateAdapter==null)return;const t=new Set;for(const r of e.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(r).forEach(s=>t.add(s));const i=this.featureAdapter.getObjectId;e.items=e.items.filter(r=>t.has(i(r)))}executeObjectIdsQuery(e){if(e.items.length===0||!e.query.objectIds?.length)return;const t=new Set(e.query.objectIds),i=this.featureAdapter.getObjectId;e.items=e.items.filter(r=>t.has(i(r)))}executeTimeQuery(e){if(e.items.length===0)return;const t=ni(this.timeInfo,e.query.timeExtent,this.featureAdapter);t!=null&&(e.items=e.items.filter(t))}executeAttributesQuery(e){if(e.items.length===0)return;const t=Z(e.query.where,this.fieldsIndex);if(t){if(!t.isStandardized)throw new TypeError("Where clause is not standardized");e.items=e.items.filter(i=>t.testFeature(i,this.featureAdapter))}}async runSpatialFilter(e,t,i){if(!t)return e;if(this._frameTask==null)return e.filter(l=>t(l));let r=0;const s=new Array,a=async l=>{for(;r<e.length;){const o=e[r++];t(o)&&(s.push(o),l.madeProgress()),l.done&&await this.reschedule(u=>a(u),i)}};return this.reschedule(l=>a(l),i).then(()=>s)}_filterLatest(e){const{trackIdField:t,startTimeField:i,endTimeField:r}=this.timeInfo,s=r||i,a=new Map,l=this.featureAdapter.getAttribute;for(const o of e.items){const u=l(o,t),c=l(o,s),h=a.get(u);(!h||c>l(h,s))&&a.set(u,o)}e.items=Array.from(a.values())}_getCacheKey(e){const{geometry:t,spatialRel:i,returnGeometry:r,returnCentroid:s,outSR:a,resultType:l,cacheHint:o}=e;if(l!=="tile"&&!o)return null;const u=r||s;return J(a)&&!Q(this.spatialReference,a)&&u?JSON.stringify([t,i,a]):JSON.stringify([t,i])}_canExecuteSinglePass(e,t){const{spatialRel:i}=t;return Tt(e)&&(i==="esriSpatialRelEnvelopeIntersects"||this.geometryType==="esriGeometryPoint"&&(i==="esriSpatialRelIntersects"||i==="esriSpatialRelContains"))}async _project(e,t){if(!t||Q(this.spatialReference,t))return e;const i=this.featureAdapter;let r;try{const a=await this._getFullExtent();r=Kt(this.spatialReference,t,a)}catch{}const s=await gs(e.items.map(a=>L(this.geometryType,this.hasZ,this.hasM,i.getGeometry(a))),this.spatialReference,t,r);return e.items=se(s.map((a,l)=>i.cloneWithGeometry(e.items[l],os(a,this.hasZ,this.hasM)))),e}async searchFeatures(e){const t=new Set;await Promise.all(e.map(r=>this.featureStore.forEachInBounds(r,s=>t.add(s))));const i=Array.from(t.values());return t.clear(),i}async _executeQueryForStatistics(e,t,i){e=he(e);try{e=await this.schedule(()=>qe(e,this.definitionExpression,this.spatialReference),i),e=await this.reschedule(()=>si(e,t,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),i);const r=await this.reschedule(()=>this._executeSceneFilterQuery(e,i),i),s=await this.reschedule(()=>this._executeGeometryQuery(e,r,i),i);return await this.reschedule(()=>this._executeAggregateIdsQuery(s),i),await this.reschedule(()=>this.executeObjectIdsQuery(s),i),await this.reschedule(()=>this.executeTimeQuery(s),i),await this.reschedule(()=>this.executeAttributesQuery(s),i),s}catch(r){if(r!==q)throw r;return new P([],e,this)}}get test(){}}function lt(n){if(Tt(n)){if(Oe(n))return[Be(Math.min(n.xmin,n.xmax),Math.min(n.ymin,n.ymax),Math.max(n.xmin,n.xmax),Math.max(n.ymin,n.ymax))];if(Pe(n))return n.rings.map(e=>Be(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1])))}return[es(ts(),n)]}export{ce as I,$i as L,P as O,lt as V,It as d,ae as h,ni as l};
